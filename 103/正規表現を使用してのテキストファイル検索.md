# 正規表現を使用してのテキストファイル検索

## 1. 正規表現の基本

正規表現は、文字列のパターンを表現するための表記法です。Linuxのさまざまなコマンドやテキストエディタで使用され、テキストの検索や置換を柔軟に行うことができます。

### 基本的な正規表現のメタ文字

| メタ文字 | 意味 |
|---------|-----|
| `.` | 任意の1文字にマッチ |
| `^` | 行の先頭にマッチ |
| `$` | 行の末尾にマッチ |
| `*` | 直前の文字の0回以上の繰り返しにマッチ |
| `[]` | 括弧内の任意の1文字にマッチ |
| `[^]` | 括弧内の文字以外の任意の1文字にマッチ |
| `\` | メタ文字をエスケープ（普通の文字として扱う） |

### 拡張正規表現のメタ文字

| メタ文字 | 意味 |
|---------|-----|
| `+` | 直前の文字の1回以上の繰り返しにマッチ |
| `?` | 直前の文字の0回または1回の出現にマッチ |
| `\|` | 選択（OR）を表す |
| `()` | グループ化 |
| `{}` | 繰り返し回数の指定 |

## 2. 主な正規表現対応コマンド

Linuxには正規表現を使って検索・操作するための様々なコマンドがあります。

### grepコマンド

ファイルから指定したパターンに一致する行を検索します。

```bash
grep [オプション] 正規表現 [ファイル...]
```

#### 主なオプション
- `-E`: 拡張正規表現を使用（egrepと同等）
- `-F`: 正規表現ではなく固定文字列として検索（fgrepと同等）
- `-i`: 大文字小文字を区別しない
- `-v`: パターンに一致しない行を表示
- `-w`: 単語全体が一致する行のみ表示
- `-l`: パターンを含むファイル名のみ表示
- `-r`: ディレクトリを再帰的に検索

### sedコマンド

テキストファイルの内容を検索・置換するためのストリームエディタです。

```bash
sed [オプション] 'コマンド' [ファイル...]
```

#### 主なコマンド
- `s/パターン/置換文字列/フラグ`: パターンを置換文字列に置き換え
  - フラグ `g`: 行内の全てのマッチを置換
  - フラグ `i`: 大文字小文字を区別しない
- `d`: 行を削除
- `p`: 行を表示
- `N,M コマンド`: N行目からM行目に対してコマンドを実行

#### 主なオプション
- `-e`: 複数のコマンドを指定
- `-i`: 直接ファイルを編集
- `-n`: 明示的に指示された行のみ出力

### awkコマンド

テキスト処理に特化したプログラミング言語です。

```bash
awk [オプション] 'パターン {アクション}' [ファイル...]
```

## 3. 正規表現の実践例

### 例1: 行末が「.exe」の行を検索

```bash
grep '\.exe$' file.txt
```

この正規表現の解説:
- `\.`: ドット（.）を普通の文字として扱う（エスケープ）
- `exe`: 文字列「exe」にマッチ
- `$`: 行末にマッチ

### 例2: 行末が「.exe」の文字列を「.sh」に置換

```bash
sed 's/\.exe$/\.sh/g' test.txt
```

この正規表現の解説:
- `s/パターン/置換文字列/g`: 置換コマンド
- `\.exe$`: 行末の「.exe」にマッチ
- `\.sh`: 置換後の文字列「.sh」
- `g`: グローバルフラグ（行内すべてのマッチを置換）

### 例3: 行の削除

```bash
# 1行目から3行目を削除
sed 1,3d test.txt
```

### 例4: Windowsの改行コード（CRLF）をLinuxの改行コード（LF）に変換

```bash
# 方法1: sedを使用
sed 's/\r$//' file1.txt > file2.txt

# 方法2: trを使用
tr -d '\r' < file1.txt > file2.txt
```

※ Linuxのエディタで `^M` と表示される文字はキャリッジリターン（CR）です。入力するには `Ctrl+V, Ctrl+M` を押します。

## 4. 練習問題

### 問題1: 行末が「.exe」の文字列を「.sh」に置換するコマンド

次のファイル内の全ての末尾が「.exe」という文字列を「.sh」に置換するには、適切なコマンドはどれか。

```
$ cat test.txt
file1.exe
execfile2
file3.exe.txt
file4.exe
file5exe
```

#### 選択肢
- `sed 's/\.exe$/\.sh/g' test.txt`
- `sed s/exe/sh/g test.txt`
- `sed s/.exe/.sh/g test.txt`
- `sed s/^exe/sh/g test.txt`
- `sed 's/\.exe/\.sh/g' test.txt`

#### 解説

- `sed 's/\.exe$/\.sh/g' test.txt`
  - 正解。`$`は行末を示す記号で、末尾の「.exe」のみが「.sh」に置換されます（1行目と4行目）。

- `sed s/exe/sh/g test.txt`
  - 全ての文字列「exe」が「sh」に置換されるため不適切です。

- `sed s/.exe/.sh/g test.txt`
  - `.`は正規表現の任意の1文字と解釈されるため、3行目と5行目も置換されてしまいます。

- `sed s/^exe/sh/g test.txt`
  - `^`は行頭を示す記号で、行頭が「exe」の行のみ置換されます。

- `sed 's/\.exe/\.sh/g' test.txt`
  - `$`（行末）の指定がないため、3行目の「.exe」も置換されてしまいます。

### 問題2: 特定の行を削除して表示するコマンド

「test.txt」ファイルの1行目から3行目を削除して表示するには、どのコマンドを使用すべきか。

#### 選択肢
- `sed 1,3d test.txt`
- `sed 1/3d test.txt`
- `sed 1;3d test.txt`
- `sed s/1/3/ test.txt`
- `sed s/1/3/g test.txt`

#### 解説

- `sed 1,3d test.txt`
  - 正解。1行目から3行目を削除します。

- `sed 1/3d test.txt`
  - 書式が誤っています。行範囲を指定するには`,`を使用します。

- `sed 1;3d test.txt`
  - 書式が誤っています。セミコロンはコマンドの区切りに使用します。

- `sed s/1/3/ test.txt`
  - 各行の最初の「1」を「3」に置換するコマンドで、行の削除ではありません。

- `sed s/1/3/g test.txt`
  - 全ての「1」を「3」に置換するコマンドで、行の削除ではありません。

### 問題3: Windowsの改行コードをLinuxの改行コードに変換するコマンド

Windowsのメモ帳で作成したテキストファイル「file1.txt」をLinuxで正しく扱うために、改行コードを変換して「file2.txt」として保存するには、どのコマンドを使用すべきか。

#### 選択肢
- `tr -d '^M' < file1.txt > file2.txt`
- `sed s//^M/g file1.txt > file2.txt`
- `sed s/^M//g file1.txt > file2.txt`
- `tr -d 'CR' < file1.txt > file2.txt`
- `sed s/CRLF/LF/g file1.txt > file2.txt`

#### 解説

改行コードと代表的なOSの組み合わせは以下のとおりです:
- CRLF（\r\n）: Windows
- LF（\n）: Unix/Linux
- CR（\r）: 古いMacOS（バージョン9まで）

- `tr -d '^M' < file1.txt > file2.txt`
  - 正解。制御コード「^M」（Ctrl+V, Ctrl+Mで入力）を削除します。リダイレクトを使ってfile1.txtを入力、file2.txtに出力します。

- `sed s/^M//g file1.txt > file2.txt`
  - 正解。sedコマンドで全ての制御コード「^M」を空白に置換（削除）します。

- `sed s//^M/g file1.txt > file2.txt`
  - 変換前の文字列が空白なのでエラーになります。

- `tr -d 'CR' < file1.txt > file2.txt`
  - 「CR」という文字列を削除するだけで、改行コードは変わりません。

- `sed s/CRLF/LF/g file1.txt > file2.txt`
  - 「CRLF」という文字列を「LF」という文字列に変換するだけで、改行コードは変わりません。

## 5. LPIC試験のポイント

- 基本的な正規表現のメタ文字（`.`、`^`、`$`、`*`、`[]`など）の意味と使い方
- sedコマンドの基本的な構文と置換操作（`s/パターン/置換/g`）
- 改行コードの違い（CRLF、LF、CR）とその変換方法
- 正規表現でのエスケープ処理（`\.`、`\*`など）
- 行範囲指定（`N,M`）と行操作（`d`、`p`など）
- 基本正規表現（BRE）と拡張正規表現（ERE）の違いと使い分け

---

## 参考資料
- Linux標準教科書（LPI）
- The GNU sed Manual
- Regular Expressions Cookbook（O'Reilly）
- Advanced Bash-Scripting Guide 