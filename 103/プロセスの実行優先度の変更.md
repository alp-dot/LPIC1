# プロセスの実行優先度の変更

## 1. プロセスの優先度とnice値

Linuxでは、各プロセスに優先度が設定されており、この優先度によってCPUリソースの割り当てが決まります。プロセスの優先度はnice値によって表され、以下の特徴があります：

- nice値の範囲：-20（最高優先度）から19（最低優先度）
- デフォルトのnice値：0
- 値が小さいほど優先度が高い
- 一般ユーザーは優先度を下げる（値を大きくする）ことのみ可能
- 一般ユーザーが優先度を上げる（値を小さくする）ことはできない
- rootユーザーは任意のnice値を設定可能

## 2. niceコマンド

niceコマンドは、指定した優先度（nice値）でコマンドを実行するためのコマンドです。

### 基本的な書式
```bash
nice [オプション] [コマンド]
```

### 主なオプション
- `-n 値`：nice値を指定（-20～19）
- `-値`：nice値を指定（短縮形）

### 使用例
```bash
# デフォルトのnice値+10（=10）でコマンドを実行
nice command

# nice値を15に指定してコマンドを実行
nice -n 15 command
nice -15 command

# 最高優先度でコマンドを実行（rootユーザーのみ可能）
nice -n -20 command
nice --20 command
```

### 特徴
- 常にnew値に対する相対値ではなく、絶対値で指定する
- オプションなしの場合は、デフォルトでnice値が10に設定される
- 一般ユーザーが負のnice値を指定すると、0に設定される（権限不足のため）

## 3. reniceコマンド

reniceコマンドは、既に実行中のプロセスのnice値を変更するためのコマンドです。

### 基本的な書式
```bash
renice [優先度] [オプション] [ターゲット]
```

### 主なオプション
- `-p PID`：プロセスIDを指定（デフォルト）
- `-u ユーザー名`：ユーザーの全プロセスを対象
- `-g プロセスグループID`：プロセスグループを対象

### 使用例
```bash
# PID 1234のプロセスのnice値を10に変更
renice 10 -p 1234

# ユーザー「username」の全プロセスのnice値を5に変更
renice 5 -u username

# 複数のプロセスのnice値を変更
renice 10 -p 1234 -p 5678

# プロセスグループ100のnice値を変更
renice 10 -g 100
```

### 特徴
- 実行中のプロセスの優先度を変更できる
- 一般ユーザーは自分のプロセスのnice値を上げる（優先度を下げる）ことのみ可能
- 一般ユーザーは自分のプロセスのnice値を下げる（優先度を上げる）ことはできない
- rootユーザーは任意のプロセスのnice値を変更可能

## 4. プロセスの優先度の確認

実行中のプロセスのnice値は、以下のコマンドで確認できます。

### psコマンドでの確認
```bash
# nice値（NI列）を表示
ps -l
ps -o pid,ppid,ni,cmd

# 全プロセスのnice値を確認
ps -el
ps -eo pid,ppid,ni,cmd
```

### topコマンドでの確認
```bash
# topコマンドを実行（NI列にnice値が表示される）
top
```

## 5. 実習例：優先度の変更と確認

### 例1：nice値を指定してコマンドを実行
```bash
# CPUに負荷をかけるコマンドを最低優先度で実行
nice -n 19 find / -name "*.log" > /dev/null 2>&1 &

# プロセスのnice値を確認
ps -o pid,ni,cmd -p $!
```

### 例2：実行中のプロセスのnice値を変更
```bash
# バックグラウンドでコマンドを実行
find / -name "*.log" > /dev/null 2>&1 &
PID=$!

# プロセスのnice値を確認
ps -o pid,ni,cmd -p $PID

# nice値を変更
renice 10 -p $PID

# 変更後のnice値を確認
ps -o pid,ni,cmd -p $PID
```

## 6. LPIC試験のポイント

- nice値の範囲（-20～19）と優先度の関係（値が小さいほど優先度が高い）
- niceコマンドとreniceコマンドの違いと使用方法
- 一般ユーザーとrootユーザーの権限の違い
- nice値を確認する方法（ps、topコマンド）
- niceコマンドのデフォルト値（10）の理解
- niceの短縮形オプションと通常オプションの使い分け

## 練習問題

### 問題1：最高優先度でプログラムを実行するコマンド

「test」プログラムを最も高い優先度で実行したい。適切なコマンドは次のうちどれか。

#### 選択肢
- `nice test`
- `nice -n 20 test`
- `nice -20 test`
- `nice --20 test`
- `nice -n -20 test`

#### 解説

- `nice test`
  - nice値10でtestプログラムが実行されるので、最高優先度ではありません。

- `nice -n 20 test`
  - nice値は-20から19までであり、20は範囲外です。実際には19（最低優先度）として扱われます。

- `nice -20 test`
  - この書式では、nice値19として解釈されます（-の後の数値は正の値として扱われる）。最低優先度になるため不適切です。

- `nice --20 test`
  - 正解。nice値-20（最高優先度）でtestプログラムが実行されます。

- `nice -n -20 test`
  - 正解。nice値-20（最高優先度）でtestプログラムが実行されます。

正解は `nice --20 test` と `nice -n -20 test` です。

---

## 参考資料
- Linux標準教科書（LPI）
- Man page for nice and renice
- Linux Process Management（O'Reilly）
- Advanced Linux Programming


